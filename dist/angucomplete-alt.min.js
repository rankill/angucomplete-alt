/*! Copyright (c) 2014 Hidenari Nozaki and contributors | Licensed under the MIT license */
"use strict";!function(a,b){"undefined"!=typeof module&&module.exports?module.exports=b(require("angular")):"function"==typeof define&&define.amd?define(["angular"],b):b(a.angular)}(window,function(a){a.module("angucomplete-alt",[]).directive("angucompleteAlt",["$q","$parse","$http","$sce","$timeout","$templateCache","$interpolate","$compile",function(b,c,d,e,f,g,h,i){function j(a){var b=document.body.getBoundingClientRect(),c=a.getBoundingClientRect(),d=c.top-b.top,e=c.left-b.left;return{left:e,top:d,height:c.height,width:c.width,distanceToBottom:b.height-c.bottom}}function k(c,g,h,k){function z(a,b){a&&("object"==typeof a?(c.searchStr=F(a),C({originalObject:a})):"string"==typeof a&&a.length>0?c.searchStr=a:console&&console.error&&console.error("Tried to set "+(b?"initial":"")+" value of angucomplete to",a,"which is an invalid value"),I(!0))}function A(a){pa=null,c.hideResults(a),document.body.removeEventListener("click",A)}function B(a){return a.which?a.which:a.keyCode}function C(b){var d=b;if(a.isDefined(c.selectedReceivedField)&&a.isDefined(d)&&"all"!==c.selectedReceivedField){var e,f=c.selectedReceivedField.split("."),g=b,h=!1;for(e=0;e<f.length;e++){if(!g.hasOwnProperty(f[e])){h=!0;break}g=g[f[e]]}h?(d=b,console.warn("[Angucomplete-alt] At least one of the fields that you type to pass to the selected object does not exist in the value array, so the value will pass as the original -> ",c.selectedReceivedField,f[e],"does not exists in the array")):d=g}"function"==typeof c.selectedObject?c.selectedObject(d):c.selectedObject=d,I(d?!0:!1)}function D(a){return function(b){return c[a]?c[a](b):b}}function E(a){C({originalObject:a}),c.clearSelected&&(c.searchStr=null),X()}function F(a){return c.titleField.split(",").map(function(b){return G(a,b)}).join(" ")}function G(a,b){var c,d;if(b){c=b.split("."),d=a;for(var e=0;e<c.length;e++)d=d[c[e]]}else d=a;return d}function H(a,b){var d,f,g;return g=new RegExp(b.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i"),a?(a.match&&a.replace||(a=a.toString()),f=a.match(g),d=f?a.replace(g,'<span class="'+c.matchClass+'">'+f[0]+"</span>"):a,e.trustAsHtml(d)):void 0}function I(a){c.notEmpty=a,ma=c.searchStr,c.fieldRequired&&k&&c.inputName&&k[c.inputName].$setValidity(la,a)}function J(a){var b=B(a);if(b!==o&&b!==m)if(b===n||b===q)a.preventDefault();else if(b===l)a.preventDefault(),!c.showDropdown&&c.searchStr&&c.searchStr.length>=ja&&(Y(),c.searching=!0,aa(c.searchStr));else if(b===p)X(),c.$apply(function(){da.val(c.searchStr)});else{if(0===ja&&!c.searchStr)return;c.searchStr&&""!==c.searchStr?c.searchStr.length>=ja&&(Y(),ka&&f.cancel(ka),c.searching=!0,ka=f(function(){aa(c.searchStr)},c.pause)):c.showDropdown=!1,ma&&ma!==c.searchStr&&!c.clearSelected&&c.$apply(function(){C()})}}function K(a){!c.overrideSuggestions||c.selectedObject&&c.selectedObject.originalObject===c.searchStr||(a&&a.preventDefault(),f.cancel(ka),U(),E(c.searchStr))}function L(a){var b=getComputedStyle(a);return a.offsetHeight+parseInt(b.marginTop,10)+parseInt(b.marginBottom,10)}function M(){return sa.getBoundingClientRect().top+parseInt(getComputedStyle(sa).maxHeight,10)}function N(){return sa.querySelectorAll(".angucomplete-row")[c.currentIndex]}function O(){return N().getBoundingClientRect().top-(sa.getBoundingClientRect().top+parseInt(getComputedStyle(sa).paddingTop,10))}function P(a){sa.scrollTop=sa.scrollTop+a}function Q(){var a=c.results[c.currentIndex];c.matchClass?da.val(F(a.originalObject)):da.val(a.title)}function R(a){var b=B(a),d=null,e=null;b===q&&c.results?(1===c.results.length?c.selectResult(c.results[0]):c.currentIndex>=0&&c.currentIndex<c.results.length?(a.preventDefault(),c.selectResult(c.results[c.currentIndex])):(K(a),X()),c.$apply()):b===l&&c.results?(a.preventDefault(),c.currentIndex+1<c.results.length&&c.showDropdown&&(c.$apply(function(){c.currentIndex++,Q()}),oa&&(d=N(),M()<d.getBoundingClientRect().bottom&&P(L(d))))):b===n&&c.results?(a.preventDefault(),c.currentIndex>=1?(c.$apply(function(){c.currentIndex--,Q()}),oa&&(e=O(),0>e&&P(e-1))):0===c.currentIndex&&c.$apply(function(){c.currentIndex=-1,da.val(c.searchStr)})):b===r?c.results&&c.results.length>0&&c.showDropdown?-1===c.currentIndex&&c.overrideSuggestions?K():(-1===c.currentIndex&&(c.currentIndex=0),c.selectResult(c.results[c.currentIndex]),c.$digest()):c.searchStr&&c.searchStr.length>0&&K():b===p&&a.preventDefault()}function S(a){return function(b,d,e,f){d||e||f||!b.data||(b=b.data),c.searching=!1,ba(G(fa(b),c.remoteUrlDataField),a)}}function T(a,b,d,e){0!==b&&-1!==b&&(b||d||e||(b=a.status),c.remoteUrlErrorCallback?c.remoteUrlErrorCallback(a,b,d,e):console&&console.error&&console.error("http error"))}function U(){na&&na.resolve()}function V(a){var e={},f=c.remoteUrl+encodeURIComponent(a);c.remoteUrlRequestFormatter&&(e={params:c.remoteUrlRequestFormatter(a)},f=c.remoteUrl),c.remoteUrlRequestWithCredentials&&(e.withCredentials=!0),U(),na=b.defer(),e.timeout=na.promise,d.get(f,e).success(S(a)).error(T)}function W(a){U(),na=b.defer(),c.remoteApiHandler(a,na.promise).then(S(a))["catch"](T)}function X(){c.showDropdown=!1,c.results=[],sa&&(sa.scrollTop=0)}function Y(){c.showDropdown=ha,c.currentIndex=c.focusFirst?0:-1,c.results=[]}function Z(a){var b,d,e,f,g=c.searchFields.split(","),h=[];for("undefined"!=typeof c.parseInput()&&(a=c.parseInput()(a)),b=0;b<c.localData.length;b++){for(d=!1,e=0;e<g.length;e++)f=G(c.localData[b],g[e])||"",d=d||f.toString().toLowerCase().indexOf(a.toString().toLowerCase())>=0;d&&(h[h.length]=c.localData[b])}c.searching=!1,ba(h,a)}function _(a,b,d){if(!d)return!1;for(var e in b)if(b[e].toLowerCase()===d.toLowerCase())return c.selectResult(a),!0;return!1}function aa(a){!a||a.length<ja||(c.localData?c.$apply(function(){Z(a)}):c.remoteApiHandler?W(a):V(a))}function ba(a,b){var d,e,f,g,h,i;if(a&&a.length>0)for(c.results=[],d=0;d<a.length;d++)c.titleField&&""!==c.titleField&&(g=h=F(a[d])),e="",c.descriptionField&&(e=i=G(a[d],c.descriptionField)),f="",c.imageField&&(f=G(a[d],c.imageField)),c.matchClass&&(h=H(g,b),i=H(e,b)),c.results[c.results.length]={title:h,description:i,image:f,originalObject:a[d]};else c.results=[];c.autoMatch&&1===c.results.length&&_(c.results[0],{title:g,desc:e||""},c.searchStr)?c.showDropdown=!1:0!==c.results.length||ia?c.showDropdown=!0:c.showDropdown=!1}function ca(){c.localData?ba(c.localData,""):c.remoteApiHandler?W(""):V("")}var da=g.find("input");a.isDefined(c.typeElementAutocomplete)&&"textarea"===c.typeElementAutocomplete&&(da=g.find("textarea"));var ea,fa,ga,ha,ia,ja=s,ka=null,la=w,ma=null,na=null,oa=!1,pa=null,qa='  <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-show="showDropdown">    <div class="angucomplete-searching" ng-show="searching" ng-bind="textSearching"></div>    <div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)" ng-bind="textNoResults"></div>    <div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseenter="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">      <div ng-if="imageField" class="angucomplete-image-holder">        <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/>        <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>      </div>      <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>      <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>      <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>      <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>    </div>  </div>',ra=i(qa)(c),sa=ra[0];c.$watchCollection(function(){return j(da[0])},function(a){$(ra).css({margin:"0 !important",width:a.width,top:a.top+a.height,left:a.left,position:"absolute",overflow:"auto","max-height":a.distanceToBottom})}),a.element(document.body).append(ra),g.on("mousedown",function(a){a.target.id?(pa=a.target.id,pa===c.id+"_dropdown"&&document.body.addEventListener("click",A)):pa=a.target.className}),c.currentIndex=c.focusFirst?0:null,c.searching=!1,ga=c.$watch("initialValue",function(a){a&&(ga(),z(a,!0))}),c.$watch("fieldRequired",function(a,b){a!==b&&(a?I(ma&&-1!==c.currentIndex?!0:!1):k[c.inputName].$setValidity(la,!0))}),c.$on("angucomplete-alt:clearInput",function(a,b){b&&b!==c.id||(c.searchStr=null,C(),I(!1),X())}),c.$on("angucomplete-alt:changeInput",function(a,b,d){b&&b===c.id&&z(d)}),c.onFocusHandler=function(){c.focusIn&&c.focusIn(),0!==ja||c.searchStr&&0!==c.searchStr.length||(c.currentIndex=c.focusFirst?0:c.currentIndex,c.showDropdown=!0,ca())},c.hideResults=function(){pa&&(pa===c.id+"_dropdown"||pa.indexOf("angucomplete")>=0)?pa=null:(ea=f(function(){X(),c.$apply(function(){c.searchStr&&c.searchStr.length>0&&da.val(c.searchStr)})},v),U(),c.focusOut&&c.focusOut(),c.overrideSuggestions&&c.searchStr&&c.searchStr.length>0&&-1===c.currentIndex&&K())},c.resetHideResults=function(){ea&&f.cancel(ea)},c.hoverRow=function(a){c.currentIndex=a},c.selectResult=function(a){c.matchClass&&(a.title=F(a.originalObject),a.description=G(a.originalObject,c.descriptionField)),c.clearSelected?c.searchStr=null:c.searchStr=a.title,C(a),X()},c.$watch(function(){return c.cleanInputOn},function(a,b){a!==b&&a&&(c.searchStr=null)}),c.inputChangeHandler=function(a){return a.length<ja?(U(),X()):0===a.length&&0===ja&&(c.searching=!1,ca()),c.inputChanged&&(a=c.inputChanged(a)),a},c.fieldRequiredClass&&""!==c.fieldRequiredClass&&(la=c.fieldRequiredClass),c.minlength&&""!==c.minlength&&(ja=parseInt(c.minlength,10)),c.pause||(c.pause=u),c.clearSelected||(c.clearSelected=!1),c.overrideSuggestions||(c.overrideSuggestions=!1),c.fieldRequired&&k&&I(c.initialValue?!0:!1),c.inputType=h.type?h.type:"text",c.textSearching=h.textSearching?h.textSearching:x,c.textNoResults=h.textNoResults?h.textNoResults:y,ha="false"===c.textSearching?!1:!0,ia="false"===c.textNoResults?!1:!0,c.maxlength=h.maxlength?h.maxlength:t,da.on("keydown",R),da.on("keyup",J),fa=D("remoteUrlResponseFormatter"),f(function(){var a=getComputedStyle(sa);oa=a.maxHeight&&"auto"===a.overflowY})}var l=40,m=39,n=38,o=37,p=27,q=13,r=9,s=3,t=524288,u=500,v=200,w="autocomplete-required",x="Searching...",y="No results found",z="/angucomplete-alt/index.html";return g.put(z,'<div class="angucomplete-holder" ng-class="{\'angucomplete-dropdown-visible\': showDropdown}">  <input ng-show="typeElementAutocomplete != \'textarea\'" id="{{id}}_value" name="{{inputName}}" ng-class="{\'angucomplete-input-not-empty\': notEmpty}" ng-model="searchStr" ng-disabled="disableInput" type="{{inputType}}" placeholder="{{placeholder}}" maxlength="{{maxlength}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="hideResults($event)" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)"/>  <textarea ng-show="typeElementAutocomplete == \'textarea\'" id="{{id}}_value" name="{{inputName}}" ng-class="{\'angucomplete-input-not-empty\': notEmpty}" ng-model="searchStr" ng-disabled="disableInput" type="{{inputType}}" placeholder="{{placeholder}}" maxlength="{{maxlength}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="hideResults($event)" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)"></textarea></div>'),{restrict:"EA",replace:"true",require:"^?form",scope:{selectedObject:"=",disableInput:"=",initialValue:"=",localData:"=",remoteUrlRequestFormatter:"=",remoteUrlRequestWithCredentials:"@",remoteUrlResponseFormatter:"=",remoteUrlErrorCallback:"=",remoteApiHandler:"=",id:"@",type:"@",placeholder:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"=",fieldRequiredClass:"@",inputChanged:"=",autoMatch:"@",focusOut:"&",focusIn:"&",inputName:"@",focusFirst:"@",parseInput:"&",cleanInputOn:"=",typeElementAutocomplete:"@",selectedReceivedField:"@"},templateUrl:function(a,b){return b.templateUrl||z},compile:function(a){var b=h.startSymbol(),c=h.endSymbol();if("{{"!==b||"}}"!==c){var d=a.html().replace(/\{\{/g,b).replace(/\}\}/g,c);a.html(d)}return k}}}])});